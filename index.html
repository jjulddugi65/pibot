<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>FOR Pi MAXIMUM TRANSACTION Demo (SDK Final)</title>    <script src="https://cdn.tailwindcss.com"></script>     <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>        /* CSS Styles */        body {            font-family: sans-serif;            background-color: #f3f4f6;            color: #1f2937;            padding: 2rem 1rem;        }        .container {            max-width: 1200px;            margin: auto;        }        .header {            background-color: #1f2937;            color: white;            padding: 2rem;            border-radius: 1rem;        }        .simulator-section {            background: white;            padding: 2rem;            margin: 2rem 0 0 0;             border-radius: 1rem 1rem 0 0;            box-shadow: 0 2px 15px -5px rgba(0, 0, 0, 0.1);        }        .inflation-chart {            height: 300px;            background: white;            padding: 1rem;            margin: 2rem 0;            border-radius: 1rem;            box-shadow: 0 2px 15px -5px rgba(0, 0, 0, 0.1);        }        /* Real-time Block Explorer iframe style */        #block_explorer_iframe {            width: 100%;            height: 150px;             border: 2px solid #e5e7eb;            border-top: none;            border-radius: 0 0 1rem 1rem;            display: block;            margin-bottom: 2rem;         }        /* SCP Consensus Animation Style */        .scp-consensus {            font-size: 0.8rem;             font-weight: bold;            color: white;             background: #4f46e5;             padding: 0.3rem 0.6rem;            border-radius: 0.5rem;            white-space: nowrap;            opacity: 0;             transition: opacity 0.3s;            margin-left: 1rem;         }        /* Ledger header container for flex */        .ledger-header-container {            display: flex;            align-items: center;            margin-bottom: 1rem;        }        /* Download button style */        .download-button {            background-color: #10b981;             color: white;            padding: 0.3rem 0.6rem;            border-radius: 0.5rem;            font-size: 0.8rem;            font-weight: bold;            cursor: pointer;            border: none;            margin-left: auto;             transition: background-color 0.2s;        }        .download-button:hover {            background-color: #059669;        }        /* Login and Payment Button Styles */        .pi-button {            padding: 0.75rem 1.5rem;            border-radius: 0.5rem;            font-weight: bold;            cursor: pointer;            border: none;            transition: background-color 0.2s;            width: 100%;            margin-bottom: 1rem;        }        .login-button {            background-color: #f7a43b; /* Pi Yellow */            color: white;        }        .login-button:hover {            background-color: #e09133;        }        .payment-button {            background-color: #4CAF50; /* Green */            color: white;        }        .payment-button:hover {            background-color: #45A049;        }        /* Input and Select styling for better visibility */        input[type="number"], select {            width: 100%;            padding: 0.5rem;            margin-top: 0.25rem;            border: 1px solid #d1d5db;            border-radius: 0.375rem;        }        /* Style for Public Key cell to ensure readability (ê¸€ê¼´ í¬ê¸° ì¶•ì†Œ ë°˜ì˜) */        .pk-cell {            font-family: monospace;            font-size: 0.65rem;         }        .grid {            display: grid;        }        .grid-cols-2 {            grid-template-columns: repeat(2, minmax(0, 1fr));        }        .gap-4 {            gap: 1rem;        }    </style>
    </head><body>
    <div id="message_box" style="z-index: 1000; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%) scale(0); transition: transform 0.3s; padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white; background-color: #1f2937;">        App Status: Ready    </div>
    <div class="container">        <div class="header rounded-xl p-6 md:p-8 flex flex-col md:flex-row items-center justify-between mb-8">            <div class="flex-1">                <p class="text-white text-lg font-semibold mb-2">FOR Pi MAXIMUM TRANSACTION (PiBot Final)</p>                <p class="text-gray-400 font-bold mb-4">Monitor real-time transactions and delegated AI activities based on your inputs.</p>            </div>            <div class="md:ml-8 mt-4 md:mt-0">                <p class="text-white text-sm font-bold text-center">Run simulation via the buttons below.</p>            </div>        </div>
        <div class="simulator-section">            <h2 class="text-2xl font-bold mb-4">Transaction Delegation Simulation (SDK Final Integrated)</h2>                        <div class="grid grid-cols-2 gap-4 mb-4">                <button id="login_button" class="pi-button login-button" onclick="piAuthenticate()">                    1. Pi Login (Identify User)                </button>                <button id="payment_button" class="pi-button payment-button" onclick="piRequestPayment()" disabled>                    2. Request Pi Payment (Start SC)                </button>            </div>            <p id="statusMessage" class="text-sm font-semibold text-center text-gray-700 mb-4">ê²°ì œ ìš”ì²­ ìƒíƒœ: ì¸ì¦ ëŒ€ê¸° ì¤‘...</p>                        <div class="grid grid-cols-2 gap-4">                <div>                    <label htmlFor="piAmount">Pi Amount (for SC Selection):</label>                    <input type="number" id="piAmount" step="0.0001" value="0.0101" placeholder="e.g. 2.5">                </div>                <div>                    <label htmlFor="taskType">Task Type:</label>                    <select id="taskType">                        <option value="Drawing">ì°½ì‘: ê·¸ë¦¼ (Drawing)</option>                        <option value="Animation">ì°½ì‘: ì• ë‹ˆë©”ì´ì…˜ (Animation)</option>                        <option value="VideoEdit">ì°½ì‘: ë™ì˜ìƒ í¸ì§‘ (Video Edit)</option>                        <option value="Research">ë°ì´í„°: ë¦¬ì„œì¹˜/ë¶„ì„ (Research/Analysis)</option>                    </select>                </div>            </div>        </div>
        <iframe id="block_explorer_iframe"                 src="https://blockexplorer.minepi.com/testnet/"                 title="Pi Testnet Block Explorer"                 frameborder="0"                allow="autoplay; encrypted-media"></iframe>
        <div id="inflation_chart" class="inflation-chart">            <div class="flex justify-between items-center mb-2">                <h3 class="text-lg font-bold text-gray-700">Pi Economy Inflation Index (Simulated)</h3>                <span id="public_tax_display" class="text-base font-bold text-green-600">Public Tax Pool: 0.0000 Pi</span>            </div>        </div>
        <div class="table-container p-6 mb-8 relative bg-white rounded-xl shadow-lg">                         <div class="ledger-header-container">                <h2 class="text-2xl font-bold text-gray-800">TRANSACTION LEDGER (Off-Chain/Logical)</h2>                                <button class="download-button" onclick="downloadLedger()">Download CSV</button>
                <div id="scp_consensus_status" class="scp-consensus" style="opacity: 0;">SCP Consensus: 0/10001 Nodes</div>            </div>
            <table class="min-w-full divide-y divide-gray-200" id="ledger_table">                <thead>                    <tr class="bg-gray-50">                        <th class="px-2 py-2 text-xs">ID</th>                        <th class="px-2 py-2 text-xs">Time</th>                        <th class="px-2 py-2 text-xs">Sender</th>                        <th class="px-2 py-2 text-xs">Smart Contract</th>                        <th class="px-2 py-2 text-xs">Pi Amount</th>                        <th class="px-2 py-2 text-xs">Task</th>                        <th class="px-2 py-2 text-xs">SC Code</th>                    </tr>                </thead>                <tbody id="smart_contract_ledger">                    </tbody>            </table>        </div>
    </div>
    <script>        // === Core Variables ===        let transactionID = 18; // ë§ˆì§€ë§‰ ID ì´í›„ë¶€í„° ì‹œì‘        const maxNodes = 10001;        let authenticatedUser = null;                 // Public Keyê°€ í¬í•¨ëœ ëª¨ì˜ ì‚¬ìš©ì ì´ë¦„ ì„¤ì • (KYC ID + ì¤„ì¸ Public Key)        const MOCK_PUBLIC_KEY_SHORT = 'GDUVQR...QO6';         const KYC_ID = '10821';         // ---------------------------------------------------------------------------------------------------------------------------------        // [í•µì‹¬ ë³€ê²½] Pi SDKì˜ ì¸ì¦ ë° ê²°ì œ ë¡œì§ì„ í†µí•©í•˜ê³ , MOCK ëŒ€ì‹  ì‹¤ì œ Pi APIë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.        // ---------------------------------------------------------------------------------------------------------------------------------
        // --- Public Tax (ê³µê³µì„¸) & Economy Variables ---        const PUBLIC_TAX_RATE = 0.01; // 1% Public Tax (0.01)        const FIXED_FEE = 0.01; // ê³ ì • ìˆ˜ìˆ˜ë£Œ (0.01 Pi)        let publicTaxPool = 0.0; // ëˆ„ì  ê³µê³µì„¸ í’€ (í•©ê³„ì•¡)        // ----------------------------------------------------
        // --- Utility Functions ---
        function showMessage(message, isSuccess = true) {            const messageBox = document.getElementById('message_box');            if (!messageBox) return; 
            messageBox.textContent = message;            messageBox.style.opacity = 1;            messageBox.style.transform = 'translateX(-50%) scale(1)';                        // Re-apply classes for styling            messageBox.classList.remove('bg-green-600', 'bg-red-600', 'bg-gray-800');            if (isSuccess) {                messageBox.style.backgroundColor = '#4CAF50'; /* Green */            } else {                messageBox.style.backgroundColor = '#F44336'; /* Red */            }                        setTimeout(() => {                messageBox.style.transform = 'translateX(-50%) scale(0)';            }, 3000);        }
        // Fix 1: ê³µê³µì„¸ í’€ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸ (ëˆ„ì  í•©ê³„ í‘œì‹œ)        function updatePublicTaxDisplay() {            const taxElement = document.getElementById('public_tax_display');            if (taxElement) {                // publicTaxPoolì€ runSimulationì—ì„œ ê³„ì† ëˆ„ì ë©ë‹ˆë‹¤.                taxElement.textContent = `Public Tax Pool: ${publicTaxPool.toFixed(4)} Pi`;            }        }
        // SCP Consensus Animation Simulation        function startSCPAnimation(scType) {            const scpStatusElement = document.getElementById('scp_consensus_status');            if (!scpStatusElement) return;
            scpStatusElement.style.opacity = 1;
            const consensusSteps = [31, 314, 3141, maxNodes];             let stepIndex = 0;                        showMessage(`AI selected ${scType}. Starting MOCKED SCP Consensus...`, true); 
            const interval = setInterval(() => {                const currentCount = consensusSteps[stepIndex];                scpStatusElement.textContent = `SCP Consensus: ${currentCount}/${maxNodes} Nodes`;                                stepIndex++;                if (stepIndex >= consensusSteps.length) {                    clearInterval(interval);                    scpStatusElement.textContent = `SCP Consensus: 10001/${maxNodes} Nodes (Finalized)`;                }            }, 500);         }                
        // --- Pi SDK Authentication (Login) Logic ---
        function piAuthenticate() {
            // [í†µí•©: ì‹¤ì œ Pi.authenticate]
            document.getElementById('statusMessage').innerText = "â³ 1. ì‚¬ìš©ì ì¸ì¦ ëŒ€ê¸° ì¤‘...";
            try {
                Pi.authenticate(["username", "payments"], onAuthenticate);
            } catch(e) {
                document.getElementById('statusMessage').innerText = `ğŸš« ì¸ì¦ ì´ˆê¸°í™” ì˜¤ë¥˜: ${e.message}`;
                showMessage(`ì¸ì¦ ì´ˆê¸°í™” ì‹¤íŒ¨: ${e.message}`, false);
            }
        }
        
        function onAuthenticate(auth) {
            if (auth.user) {
                authenticatedUser = auth.user.username;
                const userDisplay = authenticatedUser.substring(0, 10) + '...';
                document.getElementById('statusMessage').innerText = `âœ… Pi ID: ${authenticatedUser} ì¸ì¦ ì„±ê³µ.`;
                showMessage(`Pi ID: ${userDisplay} authenticated successfully!`, true);
                
                // ë¡œê·¸ì¸ ë²„íŠ¼ ë¹„í™œì„±í™”, ê²°ì œ ë²„íŠ¼ í™œì„±í™”
                document.getElementById('login_button').disabled = true;
                document.getElementById('payment_button').disabled = false;
            } else {
                document.getElementById('statusMessage').innerText = "ğŸš« Pi ì¸ì¦ ì‹¤íŒ¨.";
                showMessage("Pi ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
            }
        }
        
        // --- Pi SDK Payment Request Logic ---
        function piRequestPayment() {
            if (!authenticatedUser) {
                showMessage("Pi ì¸ì¦ì„ ë¨¼ì € í•´ì£¼ì‹­ì‹œì˜¤.", false);
                return;
            }

            const amount = parseFloat(document.getElementById('piAmount').value);
            const taskType = document.getElementById('taskType').value; 
            
            if (isNaN(amount) || amount <= 0) { 
                 showMessage("ìœ íš¨í•œ Pi ê¸ˆì•¡ì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤.", false); 
                 return;
            }
            
            const minRequiredAmount = 0.0101;
            if (amount < minRequiredAmount) { 
                 showMessage(`Pi ê¸ˆì•¡ì€ ìµœì†Œ ${minRequiredAmount.toFixed(4)} Pi ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`, false);
                 return;
            }
            
            // [í†µí•©: ì‹¤ì œ Pi.createPayment ë¡œì§]
            document.getElementById('statusMessage').innerText = "â³ 2. íŠ¸ëœì­ì…˜ ìš”ì²­ ì¤‘... (Pi Browser íŒì—… í™•ì¸)";
            
            const paymentData = {
                amount: amount, 
                memo: `PiBot Service Fee for ${taskType}`, 
                metadata: {
                    taskType: taskType,
                    workCost: (amount - FIXED_FEE) / (1 + PUBLIC_TAX_RATE) 
                }
            };
            
            const paymentCallbacks = {
                onReadyForServerApproval: function(paymentId) {
                    document.getElementById('statusMessage').innerText = "âœ… ê²°ì œ ID ìƒì„±ë¨. ì„œë²„ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ (ì‹¤ì œ ê²°ì œëŠ” ì—¬ê¸°ì„œ ë°±ì—”ë“œ ì²˜ë¦¬)";
                    showMessage("ì„œë²„ ìŠ¹ì¸ ë‹¨ê³„ ì§„ì…. ë°±ì—”ë“œ ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.", true);
                    
                    // ê²°ì œê°€ ì‹œì‘ë˜ì—ˆìœ¼ë¯€ë¡œ, ì‹œë®¬ë ˆì´ì…˜ ë¡œì§ì„ ì‹¤í–‰í•˜ì—¬ ì¥ë¶€ì— ê¸°ë¡í•©ë‹ˆë‹¤.
                    runSimulation(taskType);
                },
                onReadyForServerCompletion: function(paymentId, txid) {
                    document.getElementById('statusMessage').innerText = "ğŸ‰ ë¸”ë¡ì²´ì¸ ê±°ë˜ ì™„ë£Œ! ì‹¬ì‚¬ìœ„ì›ë‹˜, ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                    showMessage("ğŸ‰ íŠ¸ëœì­ì…˜ ì„±ê³µ!", true);
                },
                onCancel: function() {
                    document.getElementById('statusMessage').innerText = "âŒ ì‚¬ìš©ìê°€ ê²°ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.";
                    showMessage("ê²°ì œ ì·¨ì†Œ.", false);
                },
                onError: function(error) {
                    document.getElementById('statusMessage').innerText = `ğŸš« ê²°ì œ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                    showMessage(`ğŸš« ê²°ì œ ì˜¤ë¥˜: ${error.message}`, false);
                }
            };

            Pi.createPayment(paymentData, paymentCallbacks).then(function(payment) {
                console.log("Payment initiated:", payment);
            }).catch(function(error) {
                document.getElementById('statusMessage').innerText = `âš ï¸ ê²°ì œ ìš”ì²­ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`;
                console.error("Payment initialization error:", error);
            });
        }
        
        // --- Simulation & Core Logic (Called upon successful payment initiation) ---        
        function runSimulation(taskType) {            
            const piAmountInput = document.getElementById('piAmount').value;            
            const amount = parseFloat(piAmountInput);                        
            
            // --- 1. ê²½ì œ ë¡œì§: ì‘ì—… ë¹„ìš© (W), ê³µê³µì„¸ (P), ê³ ì • ìˆ˜ìˆ˜ë£Œ (F) ì—­ì‚° ---            
            // W = (A - F) / (1 + T)            
            const workCost = (amount - FIXED_FEE) / (1 + PUBLIC_TAX_RATE);                        
            
            // ê³µê³µì„¸ ê³„ì‚°: ì§•ìˆ˜            
            const publicTax = workCost * PUBLIC_TAX_RATE;                        
            
            // ê³µê³µì„¸ í’€ì— ëˆ„ì  í•©ê³„ ì ë¦½ ë° ì—…ë°ì´íŠ¸            
            publicTaxPool += publicTax;            
            updatePublicTaxDisplay();             
            // ------------------------------------------------------------------

            // 2. Smart Contract Selection (Work Cost ê¸°ì¤€ìœ¼ë¡œ 1st/2nd SC ì„ íƒ)            
            let scType = workCost >= 2.0 ? '2nd SC (Market)' : '1st SC (Survival)';
            
            startSCPAnimation(scType); 
            const ledger = document.getElementById('smart_contract_ledger');                        
            
            // Main Transaction ID            
            transactionID++;            
            const mainID = transactionID;                        
            
            // AIì—ê²Œ ë¶„ë°°ë˜ëŠ” ìˆœìˆ˜ ì‘ì—… ë¹„ìš© (Work Cost)ì„ AI1ê³¼ AI2ì—ê²Œ ì ˆë°˜ì”© ë¶„í•             
            const subAmountNet = (workCost / 2.0).toFixed(5);            
            const senderName = authenticatedUser ? authenticatedUser : KYC_ID + '_...QO6'; // Fallback            
            const currentTime = new Date().toLocaleTimeString();
            
            // AI ì‘ì—… ê²°ê³¼ ì‹œë®¬ë ˆì´ì…˜: 90% ì„±ê³µ, 10% ì‹¤íŒ¨            
            const getAIResult = () => (Math.random() < 0.9) ? 'SUCCESS' : 'FAILURE';            
            const subResult1 = getAIResult();            
            const subResult2 = getAIResult();                        
            
            // 3. Main Transaction (User calling the SC) - Total Amount                        
            // ë¡œì§ ëª…ì‹œë¥¼ ìœ„í•´ scTypeì„ ì¬ì„¤ì • (ì‚¬ìš©ì í”¼ë“œë°± ë°˜ì˜)            
            let scDisplay = scType;            
            if (scType.includes('1st SC')) {                
                scDisplay = '1st SC (0.0101/n)';            
            }                        
            
            let newRowMain = ledger.insertRow();            
            newRowMain.innerHTML = `                
                <td class="px-2 py-2 text-xs font-bold">${mainID}</td>                
                <td class="px-2 py-2 text-xs">${currentTime}</td>                
                <td class="px-2 py-2 text-xs font-bold pk-cell">${senderName} (Main T1)</td>                
                <td class="px-2 py-2 text-xs">${scDisplay}</td>                 
                <td class="px-2 py-2 text-xs font-bold">${amount.toFixed(4)}</td>                
                <td class="px-2 py-2 text-xs">${taskType}</td>                 
                <td class="px-2 py-2 text-xs">CALLED</td>            
            `;
            
            // 4. Ledger Entry: Fixed Fee ì§•ìˆ˜ ê¸°ë¡ (Creator ì§€ë¶ˆ)            
            transactionID++;             
            let newRowFee = ledger.insertRow();            
            newRowFee.innerHTML = `                
                <td class="px-2 py-2 text-xs">${transactionID}</td>                
                <td class="px-2 py-2 text-xs">${currentTime}</td>                
                <td class="px-2 py-2 text-xs">SYSTEM (Fee T2)</td>                
                <td class="px-2 py-2 text-xs font-bold text-red-700">FIXED FEE (0.01)</td>                
                <td class="px-2 py-2 text-xs font-bold text-red-700">-${FIXED_FEE.toFixed(4)}</td>                
                <td class="px-2 py-2 text-xs">Network Op</td>                
                <td class="px-2 py-2 text-xs">COLLECTED</td>            
            `;                        
            
            // 5. Ledger Entry: Public Tax ì§•ìˆ˜ ê¸°ë¡ (Creator ì§€ë¶ˆ)            
            transactionID++;             
            let newRowTax = ledger.insertRow();            
            newRowTax.innerHTML = `                
                <td class="px-2 py-2 text-xs">${transactionID}</td>                
                <td class="px-2 py-2 text-xs">${currentTime}</td>                
                <td class="px-2 py-2 text-xs">SYSTEM (Tax T3)</td>                
                <td class="px-2 py-2 text-xs font-bold text-red-600">PUBLIC TAX (1%)</td>                
                <td class="px-2 py-2 text-xs font-bold text-red-600">-${publicTax.toFixed(4)}</td>                
                <td class="px-2 py-2 text-xs">Public Fund</td>                
                <td class="px-2 py-2 text-xs">COLLECTED</td>            
            `;                        
            
            // 6. Sub Transaction 1 (AI1 Activity & Net Amount Distribution) - Fix 2 ì ìš©: ì‹¤íŒ¨ ì‹œ ë¹¨ê°„ìƒ‰ í‘œì‹œ            
            let newRow1 = ledger.insertRow();            
            newRow1.innerHTML = `                
                <td class="px-2 py-2 text-xs">${mainID}-01</td>                
                <td class="px-2 py-2 text-xs">${currentTime}</td>                
                <td class="px-2 py-2 text-xs">AI1 (1/2 Net T4)</td>                
                <td class="px-2 py-2 text-xs">${scType} Process</td>                
                <td class="px-2 py-2 text-xs font-bold text-green-600">+${subAmountNet}</td>                
                <td class="px-2 py-2 text-xs">${taskType} Process</td>                
                <td class="px-2 py-2 text-xs font-bold ${subResult1 === 'FAILURE' ? 'text-red-600' : 'text-indigo-600'}">${subResult1}</td>            
            `;                        
            
            // 7. Sub Transaction 2 (AI2 Activity & Net Amount Distribution) - Fix 2 ì ìš©: ì‹¤íŒ¨ ì‹œ ë¹¨ê°„ìƒ‰ í‘œì‹œ ë° ê¸ˆì•¡ í‘œì‹œ í†µì¼            
            let newRow2 = ledger.insertRow();            
            newRow2.innerHTML = `                
                <td class="px-2 py-2 text-xs">${mainID}-02</td>                
                <td class="px-2 py-2 text-xs">${currentTime}</td>                
                <td class="px-2 py-2 text-xs">AI2 (1/2 Net T4)</td>                
                <td class="px-2 py-2 text-xs">${scType} Process</td>                
                <td class="px-2 py-2 text-xs font-bold text-green-600">+${subAmountNet}</td>                
                <td class="px-2 py-2 text-xs">${taskType} Process</td>                
                <td class="px-2 py-2 text-xs font-bold ${subResult2 === 'FAILURE' ? 'text-red-600' : 'text-indigo-600'}">${subResult2}</td>            
            `;
            
            showMessage(`Transaction recorded: Work Cost ($${workCost.toFixed(4)}), Tax ($${publicTax.toFixed(4)}), Fee ($${FIXED_FEE.toFixed(4)}) separated.`, true);        
        }                

        // --- Ledger Download Function (Unchanged) ---        
        function downloadLedger() {            
            const table = document.getElementById('ledger_table');            
            let csv = [];                        
            
            // 1. Get Headers            
            const headerRow = table.querySelector('thead tr');            
            let row = [];            
            headerRow.querySelectorAll('th').forEach(th => {                
                row.push(th.innerText);            
            });            
            csv.push(row.join(','));
            
            // 2. Get Data Rows            
            table.querySelectorAll('#smart_contract_ledger tr').forEach(tr => {                
                row = [];                
                tr.querySelectorAll('td').forEach(td => {                    
                    let data = td.innerText.replace(/"/g, '""');                     
                    row.push(`"${data}"`);                
                });                
                csv.push(row.join(','));            
            });
            
            // 3. Download the CSV            
            const csvString = csv.join('\n');            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });            
            const url = URL.createObjectURL(blob);            
            const link = document.createElement('a');                        
            
            link.setAttribute('href', url);            
            link.setAttribute('download', 'pi_governance_ledger.csv');            
            link.style.visibility = 'hidden';            
            document.body.appendChild(link);            
            link.click();            
            document.body.removeChild(link);
            
            showMessage("Ledger downloaded successfully!", true);        
        }

        // --- DOM Content Loaded Initialization (D3 Chart is now correctly initialized) ---        
        document.addEventListener('DOMContentLoaded', () => {            
            // Fix 1: Public Tax Display ì´ˆê¸°í™”            
            updatePublicTaxDisplay();                        
            
            // D3.js Inflation Chart Initialization (Unchanged)            
            const data = [1.5, 2.3, 1.8, 2.6, 3.0, 2.7, 3.2];            
            const margin = {top: 20, right: 20, bottom: 40, left: 40};            
            const chartDiv = document.getElementById('inflation_chart');            
            const containerWidth = chartDiv.clientWidth - 20;            
            const width = (containerWidth > 800 ? 800 : containerWidth) - margin.left - margin.right;             
            const height = 300 - margin.top - margin.bottom;
            
            const svgContainer = d3.select('#inflation_chart').append('div')                
                .style('width', '100%')                
                .style('height', `${height + margin.top + margin.bottom}px`);
            
            const svg = svgContainer.append('svg')               
                .attr('width', '100%')                
                .attr('height', height + margin.top + margin.bottom);                        
            
            const x = d3.scaleBand().range([0, width]).padding(0.3);            
            const y = d3.scaleLinear().range([height, 0]);
            
            const g = svg.append("g")                
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
            x.domain(data.map((d, i) => 'Q' + (i + 1)));             
            y.domain([0, d3.max(data, d => d) + 0.5]);
            
            g.append("g")                
                .attr("transform", "translate(0," + height + ")")                
                .call(d3.axisBottom(x));
            
            g.append("g")                
                .call(d3.axisLeft(y).ticks(5));
            
            g.selectAll(".bar")                
                .data(data)                
                .enter().append("rect")                
                .attr("class", "bar")                
                .attr("x", (d, i) => x('Q' + (i + 1)))                
                .attr("y", d => y(d))                
                .attr("width", x.bandwidth())                
                .attr("height", d => height - y(d))                
                .attr("fill", "#6366f1");        
        });    
    </script>
</body></html>
